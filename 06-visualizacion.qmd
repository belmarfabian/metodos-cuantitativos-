# Visualización de datos {#visualizacion}

## Objetivos del capítulo {.unnumbered}

Al finalizar este capítulo, serás capaz de:

- Aplicar principios de diseño gráfico efectivo
- Usar la gramática de gráficos (grammar of graphics) con ggplot2
- Crear y personalizar múltiples tipos de gráficos
- Identificar visualizaciones problemáticas y mejorarlas
- Combinar múltiples gráficos en una figura
- Exportar gráficos para publicación

```{r setup-06, include=FALSE}
library(tidyverse)
library(scales)
library(patchwork)
library(ggrepel)

# Configuración global de gráficos
theme_set(theme_minimal(base_size = 11))

# Datos simulados: elecciones presidenciales en comunas chilenas
set.seed(2024)
n_comunas <- 346

comunas <- data.frame(
  comuna_id = 1:n_comunas,
  region = sample(c("Metropolitana", "Valparaíso", "Biobío", "Otras"), 
                  n_comunas, replace = TRUE, prob = c(0.40, 0.15, 0.12, 0.33)),
  poblacion = exp(rnorm(n_comunas, log(50000), 1.2)),
  izquierda_2017 = pmax(0, pmin(100, rnorm(n_comunas, 42, 12))),
  derecha_2017 = pmax(0, pmin(100, rnorm(n_comunas, 38, 11)))
)

comunas <- comunas %>%
  mutate(
    izquierda_2021 = pmax(0, pmin(100, izquierda_2017 + rnorm(n_comunas, 8, 6))),
    derecha_2021 = pmax(0, pmin(100, derecha_2017 - rnorm(n_comunas, 6, 5))),
    cambio_izquierda = izquierda_2021 - izquierda_2017,
    urbano = runif(n_comunas) > 0.3
  )

# Datos de series temporales: aprobación presidencial
aprobacion <- data.frame(
  mes = seq(as.Date("2022-03-01"), by = "month", length.out = 24),
  aprobacion = 50 + 10 * sin(seq(0, 2*pi, length.out = 24)) + rnorm(24, 0, 3),
  desaprobacion = 35 - 8 * sin(seq(0, 2*pi, length.out = 24)) + rnorm(24, 0, 3)
)
aprobacion$indeciso <- 100 - aprobacion$aprobacion - aprobacion$desaprobacion
```

## Principios y gramática de gráficos

@tufte1983 estableció principios fundamentales de diseño gráfico que permanecen vigentes:

### 1. Maximizar el ratio datos-tinta

Eliminar elementos innecesarios. Cada elemento gráfico debe comunicar información.

**Mal ejemplo** (chartjunk):

```{r fig.cap="Gráfico con elementos innecesarios", fig.height=3}
# Gráfico sobrecargado
ggplot(comunas %>% slice(1:10), aes(x = reorder(region, -izquierda_2021), y = izquierda_2021)) +
  geom_bar(stat = "identity", fill = "red", color = "gold", linewidth = 2) +
  geom_text(aes(label = round(izquierda_2021, 0)), vjust = -0.5, size = 6, color = "blue") +
  labs(title = "!!!VOTO DE IZQUIERDA POR REGIÓN!!!", 
       x = "REGIÓN", y = "PORCENTAJE (%)") +
  theme_dark() +
  theme(
    plot.background = element_rect(fill = "yellow"),
    panel.grid.major = element_line(color = "purple", linewidth = 2),
    axis.text = element_text(size = 14, face = "bold", color = "red")
  )
```

**Buen ejemplo** (limpio):

```{r fig.cap="Gráfico limpio y efectivo", fig.height=3}
comunas %>%
  group_by(region) %>%
  summarise(izquierda_media = mean(izquierda_2021)) %>%
  ggplot(aes(x = reorder(region, izquierda_media), y = izquierda_media)) +
  geom_col(fill = "steelblue", width = 0.7) +
  coord_flip() +
  labs(x = NULL, y = "Voto izquierda (%)", 
       title = "Promedio de voto izquierda por región, 2021") +
  theme_minimal()
```

### 2. Usar el canal visual apropiado

La percepción humana procesa algunos atributos visuales mejor que otros:

| Precisión | Canal visual | Ejemplo |
|:---------:|--------------|---------|
| 1 (mejor) | Posición en eje común | Barras, scatter |
| 2 | Longitud | Barras |
| 3 | Ángulo/pendiente | Líneas |
| 4 | Área | Burbujas |
| 5 | Volumen | 3D (evitar) |
| 6-7 (peor) | Color | Mapas de calor |

Esto explica por qué gráficos de barras son más precisos que gráficos de torta.

```{r fig.cap="Comparación: barras vs. torta", fig.height=3}
datos_partidos <- data.frame(
  partido = c("PS", "DC", "RN", "UDI", "Otros"),
  votos = c(23, 18, 22, 19, 18)
)

p1 <- ggplot(datos_partidos, aes(x = reorder(partido, votos), y = votos)) +
  geom_col(fill = "steelblue") +
  coord_flip() +
  labs(x = NULL, y = "Votos (%)", title = "Gráfico de barras") +
  theme_minimal()

p2 <- ggplot(datos_partidos, aes(x = "", y = votos, fill = partido)) +
  geom_bar(stat = "identity", width = 1) +
  coord_polar("y") +
  labs(title = "Gráfico de torta") +
  theme_void() +
  theme(legend.position = "right")

p1 | p2
```

El gráfico de barras permite comparaciones precisas. El gráfico de torta dificulta distinguir diferencias pequeñas.

### 3. Mostrar comparaciones

Los datos adquieren significado mediante comparación. Comparar contra:
- Otros grupos
- Otros momentos
- Un estándar o objetivo

```{r fig.cap="Comparación de cambio electoral 2017-2021", fig.height=4}
comunas_muestra <- comunas %>%
  slice_sample(n = 20)

ggplot(comunas_muestra, aes(x = izquierda_2017, xend = izquierda_2021, 
                             y = reorder(comuna_id, izquierda_2021))) +
  geom_segment(aes(yend = comuna_id), color = "gray70", linewidth = 1) +
  geom_point(aes(x = izquierda_2017, color = "2017"), size = 3) +
  geom_point(aes(x = izquierda_2021, color = "2021"), size = 3) +
  scale_color_manual(values = c("2017" = "coral", "2021" = "steelblue")) +
  labs(x = "Voto izquierda (%)", y = "Comuna (ID)",
       title = "Cambio en voto de izquierda entre elecciones",
       color = "Año") +
  theme_minimal()
```

### 4. Mostrar causalidad y explicación

Los gráficos deben sugerir explicaciones, no solo describir.

```{r fig.cap="Relación entre urbanización y cambio electoral", fig.height=3.5}
ggplot(comunas, aes(x = urbano, y = cambio_izquierda, fill = urbano)) +
  geom_violin(alpha = 0.7, show.legend = FALSE) +
  geom_boxplot(width = 0.2, fill = "white", alpha = 0.8, show.legend = FALSE) +
  scale_x_discrete(labels = c("FALSE" = "Rural", "TRUE" = "Urbana")) +
  labs(x = "Tipo de comuna", y = "Cambio en voto izquierda (puntos porcentuales)",
       title = "Cambio electoral según urbanización",
       subtitle = "Las comunas urbanas experimentaron mayor crecimiento del voto de izquierda") +
  theme_minimal()
```

### 5. Integrar evidencia

Combinar palabras, números y gráficos para una narrativa coherente.

### Grammar of Graphics y ggplot2

@wilkinson2005 propuso que los gráficos estadísticos tienen una gramática—componentes sistemáticos que se combinan para producir visualizaciones.

### Componentes de ggplot2

| Componente | Función | Ejemplo |
|------------|---------|---------|
| **Datos** | Dataset a graficar | `ggplot(datos, ...)` |
| **Aesthetics** | Mapeo variables → visual | `aes(x, y, color, size)` |
| **Geometrías** | Forma de representación | `geom_point()`, `geom_line()` |
| **Escalas** | Traducción de valores | `scale_color_manual()` |
| **Facetas** | Paneles múltiples | `facet_wrap()` |
| **Temas** | Estética general | `theme_minimal()` |

### Estructura básica

```{r eval=FALSE}
ggplot(data = <DATOS>, aes(x = <VAR_X>, y = <VAR_Y>)) +
  geom_<TIPO>() +
  scale_<...>() +
  facet_<...>() +
  labs(...) +
  theme_<...>()
```

### Ejemplo paso a paso

```{r fig.cap="Construcción progresiva de un gráfico", fig.height=8}
# Paso 1: Solo datos y aesthetics (nada se dibuja)
p1 <- ggplot(comunas, aes(x = izquierda_2017, y = izquierda_2021))

# Paso 2: Agregar geometría
p2 <- p1 + geom_point(alpha = 0.5)

# Paso 3: Agregar línea de referencia
p3 <- p2 + geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red")

# Paso 4: Mejorar etiquetas
p4 <- p3 + labs(x = "Voto izquierda 2017 (%)", 
                y = "Voto izquierda 2021 (%)",
                title = "Cambio electoral entre elecciones")

# Combinar para mostrar progresión
(p1 + ggtitle("Paso 1: Solo aesthetics")) / 
  (p2 + ggtitle("Paso 2: + geometría")) /
  (p3 + ggtitle("Paso 3: + línea de referencia")) /
  (p4 + ggtitle("Paso 4: + etiquetas"))
```

## Tipos de gráficos

### Variables continuas

**Histograma con densidad superpuesta:**

```{r fig.cap="Distribución del cambio electoral", fig.height=3.5}
ggplot(comunas, aes(x = cambio_izquierda)) +
  geom_histogram(aes(y = after_stat(density)), bins = 30, 
                 fill = "lightblue", color = "white") +
  geom_density(color = "darkblue", linewidth = 1) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "red", linewidth = 1) +
  labs(x = "Cambio en voto izquierda (puntos porcentuales)",
       y = "Densidad",
       title = "Distribución del cambio electoral 2017-2021",
       subtitle = "La mayoría de comunas experimentó crecimiento del voto de izquierda") +
  theme_minimal()
```

**Ridgeline plot (montañas):**

```{r fig.cap="Distribuciones por región", fig.height=4}
library(ggridges)

ggplot(comunas, aes(x = cambio_izquierda, y = region, fill = region)) +
  geom_density_ridges(alpha = 0.7, show.legend = FALSE) +
  labs(x = "Cambio en voto izquierda (puntos porcentuales)",
       y = NULL,
       title = "Cambio electoral por región") +
  theme_minimal()
```

### Variables categóricas

**Gráfico de barras ordenado:**

```{r fig.cap="Frecuencias ordenadas", fig.height=3}
comunas %>%
  count(region) %>%
  ggplot(aes(x = reorder(region, n), y = n)) +
  geom_col(fill = "steelblue") +
  geom_text(aes(label = n), hjust = -0.2, size = 3.5) +
  coord_flip() +
  labs(x = NULL, y = "Número de comunas",
       title = "Comunas por región en la muestra") +
  theme_minimal()
```

**Dot plot (preferible cuando muchas categorías):**

```{r fig.cap="Dot plot como alternativa", fig.height=3}
comunas %>%
  count(region) %>%
  ggplot(aes(x = n, y = reorder(region, n))) +
  geom_point(size = 4, color = "steelblue") +
  geom_segment(aes(x = 0, xend = n, yend = region), color = "gray70") +
  labs(x = "Número de comunas", y = NULL,
       title = "Comunas por región") +
  theme_minimal()
```

### Gráficos bivariados

### Dos variables continuas: scatter plots

**Básico con línea de tendencia:**

```{r fig.cap="Relación entre voto 2017 y 2021", fig.height=4}
ggplot(comunas, aes(x = izquierda_2017, y = izquierda_2021)) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm", se = TRUE, color = "red") +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "blue") +
  labs(x = "Voto izquierda 2017 (%)", 
       y = "Voto izquierda 2021 (%)",
       title = "Relación entre apoyo de izquierda en dos elecciones",
       subtitle = "Línea roja: regresión | Línea azul: sin cambio") +
  theme_minimal()
```

**Con tercera variable (color/tamaño):**

```{r fig.cap="Scatter plot con tercera variable", fig.height=4}
ggplot(comunas, aes(x = izquierda_2017, y = izquierda_2021)) +
  geom_point(aes(color = region, size = poblacion), alpha = 0.6) +
  scale_size_continuous(labels = comma, range = c(1, 8)) +
  labs(x = "Voto izquierda 2017 (%)", 
       y = "Voto izquierda 2021 (%)",
       size = "Población", color = "Región",
       title = "Cambio electoral según región y tamaño") +
  theme_minimal()
```

**Etiquetado selectivo con ggrepel:**

```{r fig.cap="Scatter plot con etiquetas", fig.height=4}
# Identificar casos extremos para etiquetar
extremos <- comunas %>%
  filter(abs(cambio_izquierda) > 15) %>%
  mutate(label = paste0("Comuna ", comuna_id))

ggplot(comunas, aes(x = izquierda_2017, y = cambio_izquierda)) +
  geom_point(alpha = 0.3) +
  geom_point(data = extremos, color = "red", size = 3) +
  geom_text_repel(data = extremos, aes(label = label), 
                  size = 3, max.overlaps = 15) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "blue") +
  labs(x = "Voto izquierda 2017 (%)",
       y = "Cambio 2017-2021 (puntos porcentuales)",
       title = "Cambio electoral desde baseline 2017",
       subtitle = "Comunas con cambios extremos etiquetadas en rojo") +
  theme_minimal()
```

### Variable continua vs. categórica

**Boxplots comparativos:**

```{r fig.cap="Distribuciones por grupo", fig.height=3.5}
ggplot(comunas, aes(x = region, y = cambio_izquierda, fill = region)) +
  geom_boxplot(alpha = 0.7, show.legend = FALSE) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(x = NULL, y = "Cambio en voto izquierda (puntos porcentuales)",
       title = "Cambio electoral por región") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

**Violin plots con puntos:**

```{r fig.cap="Violin plot con datos individuales", fig.height=3.5}
ggplot(comunas, aes(x = region, y = cambio_izquierda, fill = region)) +
  geom_violin(alpha = 0.5, show.legend = FALSE) +
  geom_jitter(width = 0.2, alpha = 0.2, size = 0.8, show.legend = FALSE) +
  stat_summary(fun = median, geom = "point", size = 3, color = "red") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "blue") +
  labs(x = NULL, y = "Cambio en voto izquierda (p.p.)",
       title = "Distribución del cambio electoral por región",
       subtitle = "Punto rojo: mediana") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### Dos variables categóricas

**Heatmap de tabla de contingencia:**

```{r fig.cap="Heatmap de frecuencias", fig.height=3}
# Crear categorías
comunas_cat <- comunas %>%
  mutate(
    cambio_cat = cut(cambio_izquierda, 
                     breaks = c(-Inf, -5, 5, Inf),
                     labels = c("Bajó", "Estable", "Subió")),
    urbano_lab = ifelse(urbano, "Urbana", "Rural")
  )

tabla_cont <- table(comunas_cat$urbano_lab, comunas_cat$cambio_cat)

# Convertir a data frame para ggplot
tabla_df <- as.data.frame(tabla_cont)
names(tabla_df) <- c("Urbano", "Cambio", "Freq")

ggplot(tabla_df, aes(x = Cambio, y = Urbano, fill = Freq)) +
  geom_tile(color = "white") +
  geom_text(aes(label = Freq), color = "white", size = 5) +
  scale_fill_gradient(low = "lightblue", high = "darkblue") +
  labs(x = "Cambio electoral", y = "Tipo de comuna",
       fill = "Frecuencia",
       title = "Cambio electoral según urbanización") +
  theme_minimal()
```

### Series temporales

**Gráfico de líneas simple:**

```{r fig.cap="Serie temporal de aprobación presidencial", fig.height=4}
ggplot(aprobacion, aes(x = mes, y = aprobacion)) +
  geom_line(color = "steelblue", linewidth = 1) +
  geom_point(color = "steelblue", size = 2) +
  scale_x_date(date_labels = "%b %Y", date_breaks = "3 months") +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, 20)) +
  labs(x = NULL, y = "Aprobación (%)",
       title = "Evolución de aprobación presidencial",
       subtitle = "Marzo 2022 - Febrero 2024") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

**Múltiples series:**

```{r fig.cap="Múltiples series temporales", fig.height=4}
# Convertir a formato largo
aprobacion_long <- aprobacion %>%
  pivot_longer(cols = c(aprobacion, desaprobacion, indeciso),
               names_to = "categoria", values_to = "porcentaje")

ggplot(aprobacion_long, aes(x = mes, y = porcentaje, color = categoria)) +
  geom_line(linewidth = 1) +
  geom_point(size = 1.5) +
  scale_color_manual(values = c("aprobacion" = "darkgreen", 
                                 "desaprobacion" = "darkred",
                                 "indeciso" = "gray60"),
                     labels = c("Aprueba", "Desaprueba", "Indeciso")) +
  scale_x_date(date_labels = "%b %Y", date_breaks = "3 months") +
  scale_y_continuous(limits = c(0, 100)) +
  labs(x = NULL, y = "Porcentaje (%)", color = NULL,
       title = "Evaluación presidencial a lo largo del tiempo") +
  theme_minimal() +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 45, hjust = 1))
```

**Área apilada:**

```{r fig.cap="Gráfico de área apilada", fig.height=4}
ggplot(aprobacion_long, aes(x = mes, y = porcentaje, fill = categoria)) +
  geom_area(alpha = 0.8) +
  scale_fill_manual(values = c("aprobacion" = "darkgreen", 
                                "desaprobacion" = "darkred",
                                "indeciso" = "gray60"),
                    labels = c("Aprueba", "Desaprueba", "Indeciso")) +
  scale_x_date(date_labels = "%b %Y", date_breaks = "3 months") +
  scale_y_continuous(limits = c(0, 100), expand = c(0, 0)) +
  labs(x = NULL, y = "Porcentaje (%)", fill = NULL,
       title = "Composición de evaluación presidencial") +
  theme_minimal() +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 45, hjust = 1))
```

### Facetas

Dividir gráficos en paneles según una variable categórica.

### facet_wrap

```{r fig.cap="Facet wrap por región", fig.height=5}
ggplot(comunas, aes(x = izquierda_2017, y = izquierda_2021)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "blue") +
  facet_wrap(~region, ncol = 2) +
  labs(x = "Voto izquierda 2017 (%)", 
       y = "Voto izquierda 2021 (%)",
       title = "Cambio electoral por región") +
  theme_minimal()
```

### facet_grid

```{r fig.cap="Facet grid con dos variables", fig.height=4}
comunas_cat <- comunas %>%
  mutate(
    urbano_lab = ifelse(urbano, "Urbana", "Rural"),
    cambio_cat = cut(cambio_izquierda, 
                     breaks = quantile(cambio_izquierda, c(0, 0.5, 1)),
                     labels = c("Bajo crecimiento", "Alto crecimiento"),
                     include.lowest = TRUE)
  )

ggplot(comunas_cat, aes(x = izquierda_2017, y = izquierda_2021)) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  facet_grid(urbano_lab ~ cambio_cat) +
  labs(x = "Voto izquierda 2017 (%)", 
       y = "Voto izquierda 2021 (%)",
       title = "Patrones electorales según urbanización y magnitud de cambio") +
  theme_minimal()
```

### Personalización

### Temas predefinidos

```{r fig.cap="Comparación de temas", fig.height=6}
p_base <- ggplot(comunas %>% slice_sample(n = 100), 
                 aes(x = izquierda_2017, y = izquierda_2021)) +
  geom_point() +
  labs(title = "Tema: ")

(p_base + theme_minimal() + ggtitle("theme_minimal")) |
(p_base + theme_bw() + ggtitle("theme_bw")) /
(p_base + theme_classic() + ggtitle("theme_classic")) |
(p_base + theme_light() + ggtitle("theme_light"))
```

### Personalización de elementos

```{r fig.cap="Gráfico altamente personalizado", fig.height=4}
ggplot(comunas %>% group_by(region) %>% 
         summarise(cambio_promedio = mean(cambio_izquierda)),
       aes(x = reorder(region, cambio_promedio), y = cambio_promedio)) +
  geom_col(aes(fill = cambio_promedio > 0), width = 0.7, show.legend = FALSE) +
  scale_fill_manual(values = c("TRUE" = "darkgreen", "FALSE" = "darkred")) +
  geom_hline(yintercept = 0, linewidth = 0.8) +
  coord_flip() +
  labs(
    x = NULL, 
    y = "Cambio promedio en voto izquierda (puntos porcentuales)",
    title = "Cambio electoral promedio por región",
    subtitle = "Comparación 2021 vs. 2017",
    caption = "Fuente: Datos simulados para fines pedagógicos"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 11, color = "gray30"),
    plot.caption = element_text(size = 8, color = "gray50", hjust = 0),
    axis.title.x = element_text(size = 10),
    axis.text = element_text(size = 9),
    panel.grid.minor = element_blank(),
    panel.grid.major.y = element_blank()
  )
```

### Paletas de colores

```{r fig.cap="Diferentes paletas de colores", fig.height=6}
p_color <- ggplot(comunas, aes(x = region, fill = region)) +
  geom_bar() +
  theme_minimal() +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 45, hjust = 1))

p1 <- p_color + scale_fill_brewer(palette = "Set2") + 
  ggtitle("Brewer: Set2")
p2 <- p_color + scale_fill_viridis_d() + 
  ggtitle("Viridis (accesible)")
p3 <- p_color + scale_fill_manual(values = c("#E41A1C", "#377EB8", "#4DAF4A", "#984EA3")) +
  ggtitle("Manual")

p1 / p2 / p3
```

### Combinando gráficos

El paquete `patchwork` permite combinar gráficos fácilmente.

```{r fig.cap="Combinación compleja de gráficos", fig.height=6}
# Crear gráficos individuales
p1 <- ggplot(comunas, aes(x = cambio_izquierda)) +
  geom_histogram(bins = 30, fill = "steelblue", color = "white") +
  labs(x = "Cambio electoral", y = "Frecuencia", title = "A) Distribución") +
  theme_minimal()

p2 <- ggplot(comunas, aes(x = izquierda_2017, y = izquierda_2021)) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm", color = "red") +
  labs(x = "2017", y = "2021", title = "B) Relación temporal") +
  theme_minimal()

p3 <- ggplot(comunas, aes(x = region, y = cambio_izquierda, fill = region)) +
  geom_boxplot(show.legend = FALSE) +
  labs(x = NULL, y = "Cambio electoral", title = "C) Por región") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

p4 <- ggplot(comunas, aes(x = urbano, y = cambio_izquierda, fill = urbano)) +
  geom_violin(show.legend = FALSE, alpha = 0.7) +
  scale_x_discrete(labels = c("FALSE" = "Rural", "TRUE" = "Urbano")) +
  labs(x = NULL, y = "Cambio electoral", title = "D) Por tipo") +
  theme_minimal()

# Combinar con layout específico
(p1 | p2) / (p3 | p4)
```

### Anotaciones

Agregar texto, flechas y formas para destacar patrones.

```{r fig.cap="Gráfico con anotaciones", fig.height=4}
ggplot(aprobacion, aes(x = mes, y = aprobacion)) +
  geom_line(color = "steelblue", linewidth = 1) +
  geom_point(color = "steelblue", size = 2) +
  # Anotar punto específico
  annotate("point", x = as.Date("2023-06-01"), y = 65, 
           color = "red", size = 4) +
  annotate("text", x = as.Date("2023-06-01"), y = 68, 
           label = "Pico máximo\n(Junio 2023)", size = 3.5, color = "red") +
  annotate("segment", x = as.Date("2023-06-01"), xend = as.Date("2023-06-01"),
           y = 66.5, yend = 65.5, arrow = arrow(length = unit(0.2, "cm")),
           color = "red") +
  # Área de interés
  annotate("rect", xmin = as.Date("2023-03-01"), xmax = as.Date("2023-09-01"),
           ymin = -Inf, ymax = Inf, alpha = 0.1, fill = "yellow") +
  scale_x_date(date_labels = "%b %Y", date_breaks = "3 months") +
  labs(x = NULL, y = "Aprobación (%)",
       title = "Aprobación presidencial con anotaciones",
       subtitle = "Período destacado: marzo-septiembre 2023") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### Exportar gráficos

Guardar gráficos para publicación.

```{r eval=FALSE}
# Crear gráfico
p <- ggplot(comunas, aes(x = izquierda_2017, y = izquierda_2021)) +
  geom_point() +
  theme_minimal()

# Guardar en diferentes formatos
ggsave("grafico.png", p, width = 8, height = 6, dpi = 300)
ggsave("grafico.pdf", p, width = 8, height = 6)
ggsave("grafico.svg", p, width = 8, height = 6)

# Especificar unidades
ggsave("grafico_cm.png", p, width = 20, height = 15, units = "cm", dpi = 300)
```

| Formato | Uso recomendado | Nota |
|---------|-----------------|------|
| **PNG** | Web, presentaciones | 300 dpi para calidad |
| **PDF** | Publicaciones académicas | Vectorial, escalable |
| **SVG** | Edición posterior | Illustrator/Inkscape |

## Errores comunes en visualización

### Problema 1: Eje Y truncado

```{r fig.cap="Eje truncado vs. completo", fig.height=4}
datos_ejemplo <- data.frame(
  año = 2019:2023,
  valor = c(50, 52, 51, 53, 54)
)

p_malo <- ggplot(datos_ejemplo, aes(x = año, y = valor)) +
  geom_col(fill = "steelblue") +
  coord_cartesian(ylim = c(48, 55)) +
  labs(title = "Problemático: Eje truncado exagera diferencias") +
  theme_minimal()

p_bueno <- ggplot(datos_ejemplo, aes(x = año, y = valor)) +
  geom_col(fill = "steelblue") +
  coord_cartesian(ylim = c(0, 60)) +
  labs(title = "Mejor: Eje desde cero muestra escala real") +
  theme_minimal()

p_malo | p_bueno
```

### Problema 2: Demasiadas categorías

```{r fig.cap="Reducción de categorías", fig.height=4}
# Simular datos con muchas categorías
set.seed(456)
muchas_cat <- data.frame(
  partido = paste("Partido", 1:15),
  votos = runif(15, 2, 12)
)

p_malo <- ggplot(muchas_cat, aes(x = partido, y = votos)) +
  geom_col(fill = "steelblue") +
  labs(title = "Problemático: Demasiadas categorías") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, size = 6))

# Agrupar categorías menores
muchas_cat_agrup <- muchas_cat %>%
  mutate(
    partido_agrup = ifelse(votos < 5, "Otros (menor 5%)", partido)
  ) %>%
  group_by(partido_agrup) %>%
  summarise(votos = sum(votos)) %>%
  arrange(desc(votos))

p_bueno <- ggplot(muchas_cat_agrup, aes(x = reorder(partido_agrup, votos), y = votos)) +
  geom_col(fill = "steelblue") +
  coord_flip() +
  labs(title = "Mejor: Categorías agrupadas", x = NULL) +
  theme_minimal()

p_malo | p_bueno
```

### Problema 3: Dobles ejes Y

Los dobles ejes Y pueden ser engañosos—la escala de cada eje puede manipularse para sugerir relaciones inexistentes.

**Mejor práctica:** Usar facetas o gráficos separados.

## Resumen {.unnumbered}

| Componente ggplot2 | Descripción | Ejemplo |
|--------------------|-------------|---------|
| **data** | Dataset a visualizar | `ggplot(datos, ...)` |
| **aes** | Mapeo de variables a propiedades visuales | `aes(x = var1, y = var2)` |
| **geom** | Tipo de gráfico | `geom_point()`, `geom_line()` |
| **facet** | División en paneles | `facet_wrap(~grupo)` |
| **theme** | Estilo visual | `theme_minimal()` |

| Tipo de variable | Gráfico recomendado | Geometría |
|------------------|---------------------|-----------|
| Continua (distribución) | Histograma, densidad | `geom_histogram()`, `geom_density()` |
| Continua (comparación grupos) | Boxplot, violin | `geom_boxplot()`, `geom_violin()` |
| Dos continuas | Scatter plot | `geom_point()` |
| Serie temporal | Línea | `geom_line()` |
| Categórica | Barras | `geom_bar()` |

**Principios de Tufte:** Maximizar ratio datos-tinta, evitar chartjunk, mostrar comparaciones.

## Lecturas recomendadas {.unnumbered}

**Fundamentos de visualización:**

Tufte, E. R. (1983). *The Visual Display of Quantitative Information*. Graphics Press.  
→ Clásico sobre principios de diseño gráfico efectivo.

**Aplicación práctica con ggplot2:**

Healy, K. (2018). *Data Visualization: A Practical Introduction*. Princeton University Press.  
→ Guía accesible con énfasis en ciencias sociales.

**Referencia técnica de ggplot2:**

Wickham, H. (2016). *ggplot2: Elegant Graphics for Data Analysis* (2nd ed.). Springer.  
→ Documentación comprehensiva del creador de ggplot2.

**Visualización crítica:**

Cairo, A. (2016). *The Truthful Art: Data, Charts, and Maps for Communication*. New Riders.  
→ Énfasis en honestidad y ética en visualización.

**Recursos en línea:**

- R Graph Gallery: https://www.r-graph-gallery.com/
- ggplot2 documentation: https://ggplot2.tidyverse.org/
- ColorBrewer (paletas): https://colorbrewer2.org/


## Ejercicios {.unnumbered}

::: {.ejercicios}

**1. Replicar y mejorar**

Este gráfico problemático:

```{r eval=FALSE}
ggplot(comunas, aes(x = region, y = cambio_izquierda)) +
  geom_bar(stat = "identity", fill = rainbow(4)) +
  labs(title = "CAMBIO!!!")
```

a) Identifica al menos 4 problemas
b) Crea una versión mejorada aplicando principios del capítulo
c) Justifica cada decisión de diseño

**2. Exploración visual de datos propios**

Con un dataset de tu proyecto:

a) Crea histograma/densidad de variable continua clave
b) Crea boxplot comparando grupos relevantes
c) Crea scatter plot de dos variables con línea de tendencia
d) Combina los tres gráficos en una figura con patchwork
e) Exporta en formato apropiado (300 dpi PNG)

**3. Series temporales**

Descarga datos de aprobación presidencial real (ej: CEP, Cadem).

a) Crea gráfico de línea con aprobación y desaprobación
b) Agrega anotaciones para eventos importantes (ej: estallido social, pandemia)
c) Usa facetas para comparar períodos presidenciales

**4. Visualización multivariada**

a) Crea scatter plot con tres variables (x, y, color o tamaño)
b) Agrega facetas por una cuarta variable categórica
c) Personaliza completamente (tema, colores, etiquetas)
d) Escribe interpretación de 100 palabras de patrones observados

**5. Del mal al buen gráfico**

Busca un gráfico problemático en medios (Twitter, periódicos, reportes).

a) Captura/descarga el gráfico original
b) Lista todos los problemas que identificas
c) Si tienes acceso a los datos, recréalo correctamente en ggplot2
d) Si no, crea un gráfico similar con datos simulados que demuestre la mejora
e) Escribe explicación de 150 palabras sobre qué cambió y por qué

**6. Proyecto de visualización completo**

Crea un "dashboard" de una página con 4-6 gráficos que cuenten una historia sobre tu tema de tesis:

a) Diseña layout con patchwork
b) Incluye diferentes tipos de gráficos (univariados, bivariados, temporal si aplica)
c) Usa un tema coherente en todos los gráficos
d) Agrega título general y caption con fuente
e) Exporta en alta resolución
f) Presenta a colegas y solicita feedback sobre claridad

:::

::: {#refs}
:::
